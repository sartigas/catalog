-- Gather
sqlplus / as sysdba <<EOF
START 10_role_plus_grants.sql APEX_230200
START 10_role_plus_grants.sql ORDS_METADATA
START 10_role_plus_grants.sql FLOWS_FILES
QUIT
EOF

sqlplus / as sysdba <<EOF
START 11_back_to_public.sql APEX_230200
START 11_back_to_public.sql ORDS_METADATA
START 11_back_to_public.sql FLOWS_FILES
QUIT
EOF

sqlplus / as sysdba <<EOF
START 20_create_synonyms.sql APEX_230200 APEX_REST_PUBLIC_USER
START 20_create_synonyms.sql ORDS_METADATA APEX_REST_PUBLIC_USER
START 20_create_synonyms.sql APEX_230200 DUMMY
START 20_create_synonyms.sql ORDS_METADATA DUMMY
START 20_create_synonyms.sql APEX_230200 APEX_LISTENER
START 20_create_synonyms.sql ORDS_METADATA APEX_LISTENER
START 20_create_synonyms.sql APEX_230200 ORDS_PUBLIC_USER
START 20_create_synonyms.sql ORDS_METADATA ORDS_PUBLIC_USER
START 20_create_synonyms.sql APEX_230200 APEX_PUBLIC_USER
START 20_create_synonyms.sql ORDS_METADATA APEX_PUBLIC_USER
START 20_create_synonyms.sql APEX_230200 FLOWS_FILES
START 20_create_synonyms.sql ORDS_METADATA FLOWS_FILES
QUIT
EOF

sqlplus / as sysdba <<EOF
START 40_drop_public_syns.sql APEX_230200
START 40_drop_public_syns.sql ORDS_METADATA
START 40_drop_public_syns.sql FLOWS_FILES
QUIT
EOF

sqlplus / as sysdba <<EOF
START 50_revoke_from_public.sql APEX_230200
START 50_revoke_from_public.sql ORDS_METADATA
START 50_revoke_from_public.sql FLOWS_FILES
QUIT
EOF





-- Deploy
sqlplus / as sysdba <<EOF
START script_001.sql
QUIT
EOF

sqlplus / as sysdba <<EOF
GRANT APEX_230200_ROLE TO APEX_REST_PUBLIC_USER;
GRANT APEX_230200_ROLE TO DUMMY;
GRANT APEX_230200_ROLE TO APEX_LISTENER;
GRANT APEX_230200_ROLE TO ORDS_PUBLIC_USER;
GRANT APEX_230200_ROLE TO APEX_PUBLIC_USER;
GRANT APEX_230200_ROLE TO FLOWS_FILES;
GRANT ORDS_METADATA_ROLE TO APEX_REST_PUBLIC_USER;
GRANT ORDS_METADATA_ROLE TO DUMMY;
GRANT ORDS_METADATA_ROLE TO APEX_LISTENER;
GRANT ORDS_METADATA_ROLE TO ORDS_PUBLIC_USER;
GRANT ORDS_METADATA_ROLE TO APEX_PUBLIC_USER;
GRANT ORDS_METADATA_ROLE TO FLOWS_FILES;
ALTER USER "DUMMY" DEFAULT ROLE "APEX_230200_ROLE", "ORDS_METADATA_ROLE";
QUIT
EOF

sqlplus / as sysdba <<EOF
START script_004.sql
QUIT
EOF

sqlplus / as sysdba <<EOF
START script_005.sql
QUIT
EOF

REVOKE EXECUTE ON /* PACKAGE */ "APEX_230200"."WWV_FLOW_DEBUG_API" FROM PUBLIC;
REVOKE EXECUTE ON /* PACKAGE */ "APEX_230200"."WWV_FLOW_PLUGIN_UTIL" FROM PUBLIC;

REVOKE EXECUTE ON /* PACKAGE */ "APEX_230200"."WWV_FLOW" FROM PUBLIC;
REVOKE EXECUTE ON /* TYPE */ "ORDS_METADATA"."T_ORDS_MODULE" FROM PUBLIC;

sqlplus / as sysdba <<EOF
START script_002.sql
CREATE OR REPLACE NONEDITIONABLE SYNONYM "FLOWS_FILES"."WWV_FLOW_FILE_API" FOR "APEX_240200"."WWV_FLOW_FILE_API";
QUIT
EOF

sqlplus / as sysdba <<EOF
START 60_compile_invalid.sql
QUIT
EOF

sqlplus / as sysdba <<EOF
START script_006.sql
QUIT
EOF



-- Make default roles those granted to workspace






















-- ROLLBACK

mv $ORACLE_HOME/apex $ORACLE_HOME/apex23
unzip apex_24.2.zip "apex/*" -d $ORACLE_HOME

sqlplus / as sysdba <<EOF
START 10_drop_priv_syns.sql APEX_230200 28-JAN-25
QUIT
EOF

sqlplus / as sysdba <<EOF
START script_001.sql
QUIT
EOF

DROP ROLE APEX_230200_ROLE;
DROP ROLE ORDS_METADATA_ROLE;

-- Unlock APEX_PUBLIC_USER
ALTER USER APEX_PUBLIC_USER ACCOUNT UNLOCK;

CREATE OR REPLACE NONEDITIONABLE SYNONYM "FLOWS_FILES"."WWV_FLOW_FILE_API" FOR "APEX_240200"."WWV_FLOW_FILE_API";

sqlplus / as sysdba <<EOF
START script_011.sql
QUIT
EOF

-- Go to version 24
@apexins.sql APEX APEX_FILES TEMP /i/


-- Install latest patch
NLS_LANG=American_America.AL32UTF8
export NLS_LANG

sqlplus / as sysdba @catpatch.sql






-- Utilities

SELECT 'DROP SYNONYM "'||O.OWNER||'"."'||O.OBJECT_NAME||'";'
  FROM DBA_ROLE_PRIVS G, DBA_OBJECTS O
WHERE G.GRANTEE = O.OWNER
  AND (O.CREATED > TO_DATE(:StartDate,'DD-MON-YY') AND O.CREATED < TO_DATE(:StartDate,'DD-MON-YY')+1)
  AND O.OBJECT_TYPE = 'SYNONYM'
  AND G.GRANTEE != 'SYS'
  AND G.GRANTED_ROLE = :SourceSchema||'_ROLE'
  AND G.GRANTEE NOT IN (SELECT ROLE FROM DBA_ROLES)
ORDER BY O.OWNER, O.OBJECT_NAME;